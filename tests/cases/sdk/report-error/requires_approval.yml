- name: requires approval when threshold reached and setting enabled
  fixtures:
    - empty_db
    - sdk_with_requires_approval

  steps:
    - name: first_error
      request:
        method: POST
        path: /sdk/v1/features/new_ui/report-error
        headers:
          Content-Type: application/json
          Authorization: 545C3E6A-8B17-4204-9558-9106D33B56F7
        body: {"error_type":"timeout","error_message":"Service X timeout"}
      response:
        status: 200
        headers:
          Content-Type: application/json

    - name: second_error_creates_pending_change
      request:
        method: POST
        path: /sdk/v1/features/new_ui/report-error
        headers:
          Content-Type: application/json
          Authorization: 545C3E6A-8B17-4204-9558-9106D33B56F7
        body: {"error_type":"timeout","error_message":"Service X timeout again"}
      response:
        status: 202
      dbChecks:
        - query: SELECT enabled FROM feature_params WHERE feature_id = '22222222-2222-2222-2222-222222222222' AND environment_id = 1
          result:
            - enabled: true
        - query: SELECT status, environment_id FROM pending_changes WHERE project_id = '11111111-1111-1111-1111-111111111111'
          result:
            - status: pending
              environment_id: 1
        - query: SELECT COUNT(*) as cnt FROM monitoring.error_reports WHERE feature_id = '22222222-2222-2222-2222-222222222222' AND environment_id = 1
          result:
            - cnt: 2
