- name: immediate disable when threshold reached and tag present
  fixtures:
    - empty_db
    - sdk_base
    - sdk_feature_with_auto_disable_tag
    - project_settings_immediate

  steps:
    - name: first_error
      request:
        method: POST
        path: /sdk/v1/features/new_ui/report-error
        headers:
          Content-Type: application/json
          Authorization: 545C3E6A-8B17-4204-9558-9106D33B56F7
        body: {"error_type":"timeout","error_message":"Service X timeout"}
      response:
        status: 200
        headers:
          Content-Type: application/json

    - name: second_error_threshold_hit
      request:
        method: POST
        path: /sdk/v1/features/new_ui/report-error
        headers:
          Content-Type: application/json
          Authorization: 545C3E6A-8B17-4204-9558-9106D33B56F7
        body: {"error_type":"timeout","error_message":"Service X timeout again"}
      response:
        status: 200
        headers:
          Content-Type: application/json
        json: |
          {
            "feature_key": "new_ui",
            "environment_key": "prod",
            "enabled": false,
            "auto_disabled": true
          }
      dbChecks:
        - query: SELECT enabled FROM feature_params WHERE feature_id = '22222222-2222-2222-2222-222222222222' AND environment_id = 1
          result:
            - enabled: false
        - query: SELECT COUNT(*) as cnt FROM monitoring.error_reports WHERE feature_id = '22222222-2222-2222-2222-222222222222' AND environment_id = 1
          result:
            - cnt: 2
