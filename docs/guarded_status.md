# ÔøΩÔøΩ –û—Ç—á–µ—Ç –ø–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ Guard Workflow

## ‚úÖ –ß—Ç–æ —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### üîß –ë—ç–∫–µ–Ω–¥ (Backend)

#### ‚úÖ –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞:
- **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**: –¢–∞–±–ª–∏—Ü—ã `pending_changes`, `pending_change_entities`, `project_approvers`, `project_settings`
- **–î–µ—Ç–µ–∫—Ü–∏—è guarded —Ñ–∏—á**: `IsFeatureGuarded()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–≥–∞ "guarded" —á–µ—Ä–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
- **–ö–æ–Ω—Ñ–ª–∏–∫—Ç-–ø—Ä–æ–≤–µ—Ä–∫–∞**: `CheckEntityConflict()` - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö pending changes
- **–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π**: `applyChanges()` - —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å audit_log

#### ‚úÖ API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã:
- `GET /api/v1/pending_changes` - —Å–ø–∏—Å–æ–∫ pending changes
- `GET /api/v1/pending_changes/{id}` - –¥–µ—Ç–∞–ª–∏ pending change
- `POST /api/v1/pending_changes/{id}/approve` - –∞–ø–ø—Ä—É–≤ —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π
- `POST /api/v1/pending_changes/{id}/reject` - –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ
- `POST /api/v1/pending_changes/{id}/cancel` - –æ—Ç–º–µ–Ω–∞

#### ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ñ–∏—á–∞–º–∏:
- **Feature Update**: `PUT /api/v1/features/{id}` - –ø–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å guard workflow
- **Feature Toggle**: `PUT /api/v1/features/{id}/toggle` - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å guard workflow
- **Feature Delete**: `DELETE /api/v1/features/{id}` - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å guard workflow

#### ‚úÖ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è:
- **Password verification**: –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —á–µ—Ä–µ–∑ `usersUseCase.VerifyPassword()`
- **TOTP verification**: –ó–∞–≥–ª—É—à–∫–∞ - "TOTP verification not implemented yet"

### ÔøΩÔøΩ –§—Ä–æ–Ω—Ç–µ–Ω–¥ (Frontend)

#### ‚úÖ –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
- **PendingChangesPage**: –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–æ —Å–ø–∏—Å–∫–æ–º pending changes —Å —Ç–∞–±–∞–º–∏
- **PendingChangeCard**: –ö–∞—Ä—Ç–æ—á–∫–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏ Approve/Reject/Cancel
- **GuardResponseHandler**: –û–±—Ä–∞–±–æ—Ç–∫–∞ 202/409 –æ—Ç–≤–µ—Ç–æ–≤ –æ—Ç API
- **ApprovalDialog**: –î–∏–∞–ª–æ–≥ –¥–ª—è –≤–≤–æ–¥–∞ –ø–∞—Ä–æ–ª—è/TOTP

#### ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:
- **EditFeatureDialog**: –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω GuardResponseHandler
- **ProjectPage**: –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω GuardResponseHandler –¥–ª—è toggle
- **Layout**: –î–æ–±–∞–≤–ª–µ–Ω –ø—É–Ω–∫—Ç –º–µ–Ω—é "Change Requests" —Å —Å—á–µ—Ç—á–∏–∫–æ–º

#### ‚úÖ API –∫–ª–∏–µ–Ω—Ç:
- –í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å pending changes
- –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ç–∏–ø—ã –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã

---

## ‚ùå –ß—Ç–æ –ù–ï —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–µ–ª—ã)

### üö® –ë—ç–∫–µ–Ω–¥ (Backend)

#### ‚ùå Single-user auto-approve:
- **–ü—Ä–æ–±–ª–µ–º–∞**: `GetProjectActiveUserCount()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∑–∞–≥–ª—É—à–∫—É `return 1, nil`
- **–°–ª–µ–¥—Å—Ç–≤–∏–µ**: Single-user –ø—Ä–æ–µ–∫—Ç—ã –Ω–µ –ø–æ–ª—É—á–∞—é—Ç auto-approve –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ

#### ‚ùå Feature Schedules guard workflow:
- **–°–æ–∑–¥–∞–Ω–∏–µ**: `CreateFeatureSchedule` - –ù–ï–¢ guard –ø—Ä–æ–≤–µ—Ä–∫–∏
- **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: `UpdateFeatureSchedule` - –ù–ï–¢ guard –ø—Ä–æ–≤–µ—Ä–∫–∏  
- **–£–¥–∞–ª–µ–Ω–∏–µ**: `DeleteFeatureSchedule` - –ù–ï–¢ guard –ø—Ä–æ–≤–µ—Ä–∫–∏

#### ‚ùå TOTP –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è:
- **–ó–∞–≥–ª—É—à–∫–∞**: `return fmt.Errorf("TOTP verification not implemented yet")`

#### ‚ùå –î—Ä—É–≥–∏–µ entity types:
- **Rules**: –ù–ï–¢ guard –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª
- **Flag Variants**: –ù–ï–¢ guard –ø—Ä–æ–≤–µ—Ä–∫–∏
- **Tags**: –ù–ï–¢ guard –ø—Ä–æ–≤–µ—Ä–∫–∏

### üö® –§—Ä–æ–Ω—Ç–µ–Ω–¥ (Frontend)

#### ‚ùå Single-user auto-approve:
- **–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ—Ç –ª–æ–≥–∏–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è single-user –ø—Ä–æ–µ–∫—Ç–æ–≤
- **–°–ª–µ–¥—Å—Ç–≤–∏–µ**: –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –≤–≤–µ—Å—Ç–∏ –ø–∞—Ä–æ–ª—å/TOTP

#### ‚ùå –í–∏–∑—É–∞–ª—å–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã:
- **–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ—Ç "–ø–ª–∞—à–∫–∏" (chip) –¥–ª—è —Ñ–∏—á —Å pending changes
- **–°–ª–µ–¥—Å—Ç–≤–∏–µ**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–∏–¥–∏—Ç, —á—Ç–æ —Ñ–∏—á–∞ "–∑–∞–º–æ—Ä–æ–∂–µ–Ω–∞"

#### ‚ùå Feature Schedules guard workflow:
- **–°–æ–∑–¥–∞–Ω–∏–µ**: –ù–ï–¢ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å GuardResponseHandler
- **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: –ù–ï–¢ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å GuardResponseHandler
- **–£–¥–∞–ª–µ–Ω–∏–µ**: –ù–ï–¢ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å GuardResponseHandler

#### ‚ùå –î—Ä—É–≥–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:
- **Rules**: –ù–ï–¢ guard workflow –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- **Flag Variants**: –ù–ï–¢ guard workflow –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- **Tags**: –ù–ï–¢ guard workflow –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

---

## üîß –ß—Ç–æ –Ω—É–∂–Ω–æ –¥–æ–¥–µ–ª–∞—Ç—å (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –ø–ª–∞–Ω)

### ÔøΩÔøΩ –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

#### 1. **Single-user auto-approve** (–∫—Ä–∏—Ç–∏—á–Ω–æ)
```go
// –ë—ç–∫–µ–Ω–¥: –∏—Å–ø—Ä–∞–≤–∏—Ç—å GetProjectActiveUserCount()
func (s *Service) GetProjectActiveUserCount(ctx context.Context, projectID domain.ProjectID) (int, error) {
    return s.guardService.GetProjectActiveUserCount(ctx, projectID)
}
```

#### 2. **–í–∏–∑—É–∞–ª—å–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã** (UX –∫—Ä–∏—Ç–∏—á–Ω–æ)
```tsx
// –§—Ä–æ–Ω—Ç–µ–Ω–¥: –¥–æ–±–∞–≤–∏—Ç—å chip –¥–ª—è pending changes
{pendingChangesCount > 0 && (
  <Chip 
    label={`${pendingChangesCount} pending`} 
    color="warning" 
    size="small" 
  />
)}
```

#### 3. **Feature Schedules guard workflow** (—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å)
- –î–æ–±–∞–≤–∏—Ç—å guard –ø—Ä–æ–≤–µ—Ä–∫—É –≤ `CreateFeatureSchedule`
- –î–æ–±–∞–≤–∏—Ç—å guard –ø—Ä–æ–≤–µ—Ä–∫—É –≤ `UpdateFeatureSchedule`  
- –î–æ–±–∞–≤–∏—Ç—å guard –ø—Ä–æ–≤–µ—Ä–∫—É –≤ `DeleteFeatureSchedule`
- –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å GuardResponseHandler –≤ ProjectSchedulingPage

### ü•à –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

#### 4. **TOTP –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è**
```go
// –ë—ç–∫–µ–Ω–¥: —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å TOTP verification
case "totp":
    if err := s.usersUseCase.VerifyTOTP(ctx, domain.UserID(approverUserID), credential); err != nil {
        return fmt.Errorf("TOTP verification failed: %w", err)
    }
```

#### 5. **Rules guard workflow**
- –î–æ–±–∞–≤–∏—Ç—å guard –ø—Ä–æ–≤–µ—Ä–∫—É –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª
- –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ EditFeatureDialog

#### 6. **Flag Variants guard workflow**
- –î–æ–±–∞–≤–∏—Ç—å guard –ø—Ä–æ–≤–µ—Ä–∫—É –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
- –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ EditFeatureDialog

### ÔøΩÔøΩ –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

#### 7. **Tags guard workflow**
- –î–æ–±–∞–≤–∏—Ç—å guard –ø—Ä–æ–≤–µ—Ä–∫—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è —Ç–µ–≥–æ–≤
- –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

#### 8. **–£–ª—É—á—à–µ–Ω–∏—è UX**
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ pending changes
- Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –∞–ø–ø—Ä—É–≤–µ—Ä–æ–≤
- WebSocket –¥–ª—è real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ | –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ | –ü—Ä–æ—Ü–µ–Ω—Ç |
|-----------|-------------|----------------|---------|
| **–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞** | ‚úÖ | ‚ùå | 100% |
| **Feature CRUD** | ‚úÖ | ‚ùå | 100% |
| **Pending Changes API** | ‚úÖ | ‚ùå | 100% |
| **Single-user auto-approve** | ‚ùå | ‚úÖ | 0% |
| **Feature Schedules** | ‚ùå | ‚úÖ | 0% |
| **Rules/Variants/Tags** | ‚ùå | ‚úÖ | 0% |
| **TOTP –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è** | ‚ùå | ‚úÖ | 0% |
| **–í–∏–∑—É–∞–ª—å–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã** | ‚ùå | ‚úÖ | 0% |

**–û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å: ~60%**

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

1. **–ù–∞—á–∞—Ç—å —Å single-user auto-approve** - —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è UX
2. **–î–æ–±–∞–≤–∏—Ç—å –≤–∏–∑—É–∞–ª—å–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –¥–æ–ª–∂–Ω—ã –≤–∏–¥–µ—Ç—å pending changes
3. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Feature Schedules guard workflow** - –≤–∞–∂–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
4. **–î–æ–±–∞–≤–∏—Ç—å TOTP** - –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
5. **–†–∞—Å—à–∏—Ä–∏—Ç—å –Ω–∞ –¥—Ä—É–≥–∏–µ entity types** - –¥–ª—è –ø–æ–ª–Ω–æ—Ç—ã —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∫—Ä—ã–≤–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å, –Ω–æ –µ—Å—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–µ–ª—ã –≤ UX –∏ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö.