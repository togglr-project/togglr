# üìë –¢–ó: WebSocket Broadcaster –¥–ª—è Pending Changes –∏ Audit Log

## üéØ –¶–µ–ª—å

–û–±–µ—Å–ø–µ—á–∏—Ç—å –¥–æ—Å—Ç–∞–≤–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π –æ —Ñ–∏—á–∞—Ö –∏ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç—è—Ö –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏. –£—Å—Ç—Ä–∞–Ω–∏—Ç—å –Ω–µ–∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å UI, –∫–æ–≥–¥–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –≤ –±—ç–∫–µ–Ω–¥–µ, –Ω–æ –Ω–µ –æ—Ç—Ä–∞–∂–∞—é—Ç—Å—è –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ.

---

## üì° –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### 1. –ò—Å—Ç–æ—á–Ω–∏–∫ —Å–æ–±—ã—Ç–∏–π

* –í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –µ—Å—Ç—å –æ–±—ä–µ–¥–∏–Ω—è—é—â–∞—è view `v_realtime_events`, –∫–æ—Ç–æ—Ä–∞—è –∞–≥—Ä–µ–≥–∏—Ä—É–µ—Ç —Å–æ–±—ã—Ç–∏—è –∏–∑ —Ç–∞–±–ª–∏—Ü:

    * `pending_changes` (+ `pending_change_entities`);
    * `audit_log`.
* –ö–∞–∂–¥–∞—è –∑–∞–ø–∏—Å—å —Å–æ–¥–µ—Ä–∂–∏—Ç:

    * `source` (`pending` –∏–ª–∏ `audit`),
    * `event_id` (—Å—Ç—Ä–æ–∫–∞),
    * `project_id`,
    * `environment_id` –∏ `environment_key`,
    * `entity` –∏ `entity_id`,
    * `action` (`created`, `updated`, `deleted`, `pending`, –∏ —Ç. –¥.),
    * `created_at`.

### 2. –§–æ–Ω–æ–≤—ã–π –≤–æ—Ä–∫–µ—Ä

* –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ backend.
* –†–∞–∑ –≤ N —Å–µ–∫—É–Ω–¥ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å:

  ```sql
  SELECT * FROM v_realtime_events WHERE created_at > $last_seen ORDER BY created_at ASC;
  ```
* –û–±–Ω–æ–≤–ª—è–µ—Ç `last_seen` –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –≤—ã–±–æ—Ä–∫–∏.
* –ö–∞–∂–¥–æ–µ –Ω–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –≤ JSON –∏ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ broadcaster.

### 3. Broadcaster

* –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –≤ –ø–∞–º—è—Ç–∏ backend.
* –•—Ä–∞–Ω–∏—Ç –º–∞–ø—É –∞–∫—Ç–∏–≤–Ω—ã—Ö WebSocket-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π:

  ```
  (project_id, environment_id) ‚Üí []connections
  ```
* –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–±—ã—Ç–∏—è –≤–æ—Ä–∫–µ—Ä –≤—ã–∑—ã–≤–∞–µ—Ç `Broadcast(project_id, env, event)`, –∏ –≤—Å–µ –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã –ø–æ–ª—É—á–∞—é—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ.

### 4. WebSocket-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ

* Endpoint: `/api/ws?project_id=...&env=...`
* –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è: `Authorization: Bearer <token>`
* –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–µ —Å–æ–±—ã—Ç–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –æ—Ç–Ω–æ—Å—è—Ç—Å—è –∫ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É `project_id` –∏ `environment`.

---

## üì° –§–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è

–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –∫ –∫–ª–∏–µ–Ω—Ç—É:

```json
{
  "source": "audit",
  "type": "feature_updated",
  "timestamp": "2025-09-26T12:00:00Z",
  "project_id": "abc123",
  "environment": "prod",
  "entity": "feature",
  "entity_id": "f1",
  "action": "updated"
}
```

---

## üñ• Frontend

1. –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ `/api/ws?project_id=abc123&env=prod`.
2. –ü–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (store).
3. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∏–ø–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏–π:

    * `feature_updated` ‚Üí –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ñ–∏—á—É –≤ store;
    * `feature_deleted` ‚Üí —É–¥–∞–ª–∏—Ç—å –∏–∑ store;
    * `pending_change_created` ‚Üí –ø–æ–∫–∞–∑–∞—Ç—å –≤ UI ¬´–æ–∂–∏–¥–∞–µ—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è¬ª;

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ MVP

* Backend –ø–æ–¥–Ω–∏–º–∞–µ—Ç `/api/ws`, –∫–ª–∏–µ–Ω—Ç—ã –º–æ–≥—É—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è.
* –í–æ—Ä–∫–µ—Ä –∫–∞–∂–¥—ã–µ N —Å–µ–∫—É–Ω–¥ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `v_realtime_events` –∏ –ø–µ—Ä–µ–¥–∞—ë—Ç –Ω–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏.
* –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∏—á–∏ (pending –∏–ª–∏ audit) —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ –∏ UI –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏.

---

