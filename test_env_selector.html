<!DOCTYPE html>
<html>
<head>
    <title>Environment Selector Test</title>
    <style>
        body { font-family: monospace; margin: 20px; }
        .log { margin: 5px 0; padding: 5px; border-left: 3px solid #ccc; }
        .error { border-left-color: #f00; background: #ffe6e6; }
        .success { border-left-color: #0f0; background: #e6ffe6; }
        .info { border-left-color: #00f; background: #e6f3ff; }
        .section { margin: 20px 0; padding: 10px; border: 1px solid #ccc; }
        select { margin: 10px; padding: 5px; }
    </style>
</head>
<body>
    <h1>Environment Selector Test</h1>
    <div id="logs"></div>
    
    <div class="section">
        <h3>Test Environment Selector</h3>
        <select id="env-selector" name="environment">
            <option value="">Select Environment</option>
            <option value="dev" data-env-id="1">Development (dev)</option>
            <option value="stage" data-env-id="2">Staging (stage)</option>
            <option value="prod" data-env-id="3">Production (prod)</option>
        </select>
        <button onclick="testEnvSelection()">Test Selection</button>
        <button onclick="testEnvDetection()">Test Detection</button>
    </div>
    
    <div class="section">
        <h3>Current localStorage</h3>
        <div id="localStorage"></div>
    </div>
    
    <script>
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.textContent = new Date().toISOString() + ': ' + message;
            document.getElementById('logs').appendChild(div);
            console.log(message);
        }
        
        function updateLocalStorage() {
            const div = document.getElementById('localStorage');
            div.innerHTML = '';
            
            const keys = ['currentEnvId', 'currentEnvironmentKey', 'currentProjectId'];
            keys.forEach(key => {
                const value = localStorage.getItem(key);
                const p = document.createElement('p');
                p.textContent = `${key}: ${value || 'not set'}`;
                p.style.color = value ? 'green' : 'red';
                div.appendChild(p);
            });
        }
        
        function testEnvSelection() {
            const select = document.getElementById('env-selector');
            const selectedValue = select.value;
            const selectedOption = select.querySelector(`option[value="${selectedValue}"]`);
            const envId = selectedOption ? selectedOption.getAttribute('data-env-id') : null;
            
            log(`Selected value: ${selectedValue}`, 'info');
            log(`Environment ID: ${envId}`, envId ? 'success' : 'error');
            
            if (selectedValue && envId) {
                localStorage.setItem('currentEnvId', envId);
                localStorage.setItem('currentEnvironmentKey', selectedValue);
                log(`Saved to localStorage: { id: ${envId}, key: ${selectedValue} }`, 'success');
                updateLocalStorage();
            }
        }
        
        function testEnvDetection() {
            log('=== Testing Environment Detection ===', 'info');
            
            // Test localStorage
            const envId = localStorage.getItem('currentEnvId');
            const envKey = localStorage.getItem('currentEnvironmentKey');
            
            log(`localStorage envId: ${envId || 'not found'}`, envId ? 'success' : 'error');
            log(`localStorage envKey: ${envKey || 'not found'}`, envKey ? 'success' : 'error');
            
            // Test DOM selector
            const envSelect = document.querySelector('select[name*="env"], select[id*="env"]');
            if (envSelect && envSelect.value) {
                const environmentKey = envSelect.value;
                log(`Found environment key in DOM: ${environmentKey}`, 'success');
                
                const selectedOption = envSelect.querySelector(`option[value="${environmentKey}"]`);
                if (selectedOption) {
                    const envIdFromData = selectedOption.getAttribute('data-env-id');
                    log(`Found envId from data attribute: ${envIdFromData}`, envIdFromData ? 'success' : 'error');
                }
            } else {
                log('No environment selector found in DOM', 'error');
            }
            
            // Test WebSocket connection
            if (envId && localStorage.getItem('currentProjectId')) {
                const projectId = localStorage.getItem('currentProjectId');
                const wsUrl = `ws://localhost:8082/api/ws?project_id=${projectId}&env_id=${envId}`;
                log(`WebSocket URL: ${wsUrl}`, 'info');
                
                // Test connection
                const ws = new WebSocket(wsUrl);
                ws.onopen = () => log('✅ WebSocket connected!', 'success');
                ws.onclose = (e) => log(`❌ WebSocket closed: ${e.code} - ${e.reason}`, 'error');
                ws.onerror = (e) => log('❌ WebSocket error', 'error');
            } else {
                log('Cannot test WebSocket: missing projectId or envId', 'error');
            }
        }
        
        // Set up test data
        localStorage.setItem('currentProjectId', 'test-project-123');
        updateLocalStorage();
        
        // Test on page load
        testEnvDetection();
    </script>
</body>
</html>
