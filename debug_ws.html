<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Debug</title>
    <style>
        body { font-family: monospace; margin: 20px; }
        .log { margin: 5px 0; padding: 5px; border-left: 3px solid #ccc; }
        .error { border-left-color: #f00; background: #ffe6e6; }
        .success { border-left-color: #0f0; background: #e6ffe6; }
        .info { border-left-color: #00f; background: #e6f3ff; }
    </style>
</head>
<body>
    <h1>WebSocket Debug Tool</h1>
    <div id="logs"></div>
    
    <script>
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.textContent = new Date().toISOString() + ': ' + message;
            document.getElementById('logs').appendChild(div);
            console.log(message);
        }
        
        // Test different scenarios
        function testWebSocket(projectId, envId, token) {
            log(`Testing WebSocket with projectId=${projectId}, envId=${envId}, token=${token ? 'present' : 'missing'}`, 'info');
            
            const wsUrl = `ws://localhost:8082/api/ws?project_id=${projectId}&env_id=${envId}`;
            const protocols = token ? [`bearer,${token}`] : [];
            
            log(`Connecting to: ${wsUrl}`, 'info');
            log(`Protocols: ${JSON.stringify(protocols)}`, 'info');
            
            const ws = new WebSocket(wsUrl, protocols);
            
            ws.onopen = function(event) {
                log('✅ WebSocket connected successfully!', 'success');
            };
            
            ws.onclose = function(event) {
                log(`❌ WebSocket closed: code=${event.code}, reason="${event.reason}", wasClean=${event.wasClean}`, 'error');
            };
            
            ws.onerror = function(event) {
                log('❌ WebSocket error: ' + JSON.stringify(event), 'error');
            };
            
            ws.onmessage = function(event) {
                log('📨 Message received: ' + event.data, 'success');
            };
            
            return ws;
        }
        
        // Test 1: Basic connection without auth
        log('=== Test 1: Basic connection without auth ===', 'info');
        const ws1 = testWebSocket('test-project', '1', null);
        
        // Test 2: Connection with token from localStorage
        setTimeout(() => {
            log('=== Test 2: Connection with token from localStorage ===', 'info');
            const token = localStorage.getItem('accessToken');
            const ws2 = testWebSocket('test-project', '1', token);
        }, 2000);
        
        // Test 3: Connection with URL parameters
        setTimeout(() => {
            log('=== Test 3: Connection with URL parameters ===', 'info');
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('project_id') || 'test-project';
            const envId = urlParams.get('env_id') || '1';
            const token = localStorage.getItem('accessToken');
            const ws3 = testWebSocket(projectId, envId, token);
        }, 4000);
        
        // Show current localStorage
        log('=== Current localStorage ===', 'info');
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            const value = localStorage.getItem(key);
            log(`${key}: ${value}`, 'info');
        }
        
        // Show current URL
        log(`=== Current URL ===`, 'info');
        log(`URL: ${window.location.href}`, 'info');
        log(`Path: ${window.location.pathname}`, 'info');
        log(`Search: ${window.location.search}`, 'info');
    </script>
</body>
</html>
